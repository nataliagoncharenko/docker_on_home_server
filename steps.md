# Установка Docker на Ubuntu Server на DEXP Compact M008

Обновление списка пакетов и пакетов:

sudo apt update && sudo apt upgrade -y

apt (Advanced Package Tool) - менеджер пакетов в Ubuntu (без него ни один пакет не поставить, не обновить, не удалить). Отвечает за: установку, удаление, обновление, поиск, проверку зависимостей.
Как работает:
В случае с Docker apt идет в репозиторий, находит пакет, проверяет, что еще нужно для работы программы (зависимости) и ставит все автоматически
Зависимости - программы, без которых не может работать Docker. Apt сам находит такие программы, проверяет,установлены ли они и если нет, то ставит автоматически. 

## Установка Docker 

* Установить зависимости: 
sudo apt install -y ca-certificates curl gnupg

Здесь установка трех пакетов: 
1) ca-certificates - набор доверенных сертификатов, которые используются для проверки подлинности HTTPS-сайтов. Сертификаты помогают установить безопасное соединение и защитить от подмены данных
2) curl - утилита командной строки для передачи данных по разным протоколам, нужна чтобы скачать GPG-ключ Docker
3) gnupg (инструмент для работы с GPG-ключом Docker) - инструмент для шифрования и проверки цифровых подписей. Здесь он нужен, чтобы проверить GPG-ключ Docker репозитория. Проверяет не поддельные ли ключи, без этого бы система не доверяла репозиторию. 

* Добавить официальный GPG-ключ Docker:

sudo install -m 0755 -d /etc/apt/keyrings

Разбор команды:
sudo - стандартно права администратора
install - команда, которая умеет копировать файлы и создавать директории с нужными правами 
-m 0755 - задает права доступа к папке: владелец может читать, писать и входить, все остальные только входить и читать
-d - создание директории
/etc/apt/keyrings - место у Ubuntu, куда складывают GPG-ключи для доверенных репозиториев

* Скачивание и преобразование GPG-ключа:
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

Разбор команды: 
curl -fsSL https://download.docker.com/linux/ubuntu/gpg - скачивание GPG-ключ с официального сервера
флаги -fsSL 
| - передает результат первой команды (ключ) сразу второй на вход

sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg - преобразование сырого ключа в ASCII в бинарный формат .gpg :
--dearmor - преобразование 
-o - указание, куда сохранить

* Разрешение на чтение ключа для всех 

sudo chmod a+r /etc/apt/keyrings/docker.gpg

Разбор команды:
chmod - смена прав доступа
a+r - всем добавить право на чтение (all+read)

* Добавление репозитория Docker

echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
 Разбор команды:
 - добавляет официальный репозиторий Docker в систему, чтобы apt знал, что ему можно доверять и ставить Docker

 - echo "..." - печатает строку, которая описывает откуда брать пакеты
 - deb - тип репозитория, репозиторй я бинарными пакетами, которые умеет читать apt
 - [arch=$(dpkg --print-architecture)] - указывает архитектуру процессора, команда подстановка (запускается и возвращает архитектуру процессора). Нужно, чтобы apt скачал только те пакеты, которые подходят для конкретного компьютера.
 - signed-by=/etc/apt/keyrings/docker.gpg - указывает, кто подписан, apt будет доверять только тем пакетам, которые подписаны этим ключом.
 - https://download.docker.com/linux/ubuntu - ссылка на официальный сервер Docker, где лежат пакеты для Ubuntu
 - $(. /etc/os-release && echo "$VERSION_CODENAME") - подставляет кодовое слово для Ubuntu. Для каждой версии Ubuntu свои пакеты и по кодовому слову понятно. что нужно скачать. 
 - stable - канал обновлений, т.е. это стабиотные и проверенные версии Docker
 - | sudo tee /etc/apt/sources.list.d/docker.list
 | - передает строку из echo следующей команде
sudo - потому что только администратор может писать в папку 
tee - утилита, которая записывает данные в файл
- > /dev/null - подавляет вывод результата tee

Обновление списка пакетов:
sudo apt update

Необходимо снова обновить список пакетов, т.к до этого apt не знал о репозитории Docker и он должен узнать о новых пакетах из репозитория. 

Устанавливаем Docker

sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

sudo apt install -разобраны выше
-y - флаг дает ответы "да" на все вопросы при установке

Этой командой мы устанавливаем: 

* docker-ce - Docker Community Edition
Основной движок Docker, который запускает и управляет контейнерами. 
Community Edition - беспланая полноценная версия Docker для личчного и домашнего использования.

* docker-ce-cli - командная строка Docker, с помощью которой пользователь управляет контейнерами.

* containerd.io - движок для контейнеров. Является низкоуровневым компонентом и на самом деле запускает контейнеры, отвечает за запуск процессов в контейнерах, управление образами, за сети и хранилища, используется Docker под капотом. 

* docker-buildx-plugin - многоархитектурные сборки, что позволяет собирать образы не только для ПК пользователя, но и, например, для Raspberry Pi, ARM-серверов.

* docker-compose-plugin - Docker Compose как встроенная команда, является встроенным плагином, а не отдельной утилитой, как раньше. 

Совокупность указанных пакетов составляет полный современный стек Docker, обеспечивает готовую среду для того, чтобы можно было запускать, настраивать и управлять контейнерами на домашнем сервере. 

Проверка, что Docker работает:

sudo docker run hello-world

Ожидаемый результат: сообщение "Hello from Docker!"

Добавление своего пользователя в группу, чтобы не писать sudo перед каждой командой:

sudo usermod -aG docker $USER

Команда добавляет пользовательский аккаунт в группу Docker
- usermod - системная утилита, которая изменяет параменты существующего пользователя. 

-aG - два флага склеенные вместе:
флаг -a append - добавить новую группу без удаления старых
флаг -G указывает вторичные группы и вместе флаги означают - добавить пользователя в группу Docker без удаления тех групп, где он уже состоит. Если не указать -a, то пользователь будет удален из других групп

docker - наименование группы, в которую мы добавляем пользователя, она создается автоматически при установке и участники этой группы могут общаться с Docker-демоном (серверная часть Docker) напрямую 

$USER - переменная окружения, которая содержит имя текущего пользователя, удобство в том, что не нужно вручную писать имя, команда работает универсально. 

Необходимо учитывать, что группа docker очень мощная и пользователь из этой группы может получать полный контроль над системой. Для домашнего сервера, где есть только один пользователь, это нормально и удобно, для публичного сервера или если есть несколько пользователей на домашнем сервере, необходимо разграничивать права. 

Далее 

newgrp docker 
или можно перезапустить сервер


Проверяем версию Docker Compose

docker compose version

Теперь Docker готов к работе